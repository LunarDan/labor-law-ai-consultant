<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å†å²å¯¹è¯æ¸…ç†å·¥å…·</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 800px;
      width: 100%;
      padding: 40px;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .status-box {
      background: #f7f9fc;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #e1e8ed;
    }

    .status-item:last-child {
      border-bottom: none;
    }

    .status-label {
      color: #666;
      font-weight: 500;
    }

    .status-value {
      color: #333;
      font-weight: 600;
    }

    .status-value.error {
      color: #f56c6c;
    }

    .status-value.success {
      color: #67c23a;
    }

    .status-value.warning {
      color: #e6a23c;
    }

    .button-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    button:active {
      transform: translateY(0);
    }

    button.secondary {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
    }

    button.secondary:hover {
      box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
    }

    button.danger {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
      box-shadow: 0 4px 15px rgba(250, 112, 154, 0.4);
    }

    button.danger:hover {
      box-shadow: 0 6px 20px rgba(250, 112, 154, 0.6);
    }

    .log-box {
      background: #1e1e1e;
      color: #d4d4d4;
      border-radius: 8px;
      padding: 20px;
      font-family: 'Courier New', Courier, monospace;
      font-size: 13px;
      line-height: 1.6;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 20px;
    }

    .log-item {
      margin-bottom: 5px;
    }

    .log-success {
      color: #4ec9b0;
    }

    .log-error {
      color: #f48771;
    }

    .log-warning {
      color: #dcdcaa;
    }

    .log-info {
      color: #9cdcfe;
    }

    .detail-list {
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
    }

    .detail-item {
      background: #f7f9fc;
      border-left: 4px solid #667eea;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 4px;
    }

    .detail-item.duplicate {
      border-left-color: #e6a23c;
      background: #fef6e6;
    }

    .detail-item.empty {
      border-left-color: #f56c6c;
      background: #fee;
    }

    .detail-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .detail-meta {
      font-size: 12px;
      color: #666;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ”§ å†å²å¯¹è¯æ¸…ç†å·¥å…·</h1>
    <p class="subtitle">ä¿®å¤é‡å¤å¯¹è¯å’Œç©ºå¯¹è¯é—®é¢˜</p>

    <div class="status-box" id="statusBox">
      <div class="status-item">
        <span class="status-label">å†å²è®°å½•æ€»æ•°</span>
        <span class="status-value" id="totalCount">-</span>
      </div>
      <div class="status-item">
        <span class="status-label">é‡å¤å¯¹è¯</span>
        <span class="status-value error" id="duplicateCount">-</span>
      </div>
      <div class="status-item">
        <span class="status-label">ç©ºå¯¹è¯</span>
        <span class="status-value warning" id="emptyCount">-</span>
      </div>
      <div class="status-item">
        <span class="status-label">æœ‰æ•ˆå¯¹è¯</span>
        <span class="status-value success" id="validCount">-</span>
      </div>
    </div>

    <div class="button-group">
      <button onclick="analyzeHistory()">ğŸ“Š åˆ†æå†å²è®°å½•</button>
      <button class="secondary" onclick="cleanHistory()">ğŸ§¹ æ¸…ç†é‡å¤å’Œç©ºè®°å½•</button>
      <button class="danger" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è®°å½•</button>
    </div>

    <div id="detailList" class="detail-list" style="display: none;"></div>

    <div class="log-box" id="logBox">
      <div class="log-item log-info">ğŸ”¹ ç­‰å¾…æ“ä½œ...</div>
    </div>
  </div>

  <script>
    function log(message, type = 'info') {
      const logBox = document.getElementById('logBox');
      const timestamp = new Date().toLocaleTimeString();
      const icons = {
        info: 'ğŸ”¹',
        success: 'âœ…',
        error: 'âŒ',
        warning: 'âš ï¸'
      };
      const logItem = document.createElement('div');
      logItem.className = `log-item log-${type}`;
      logItem.textContent = `[${timestamp}] ${icons[type]} ${message}`;
      logBox.appendChild(logItem);
      logBox.scrollTop = logBox.scrollHeight;
    }

    function updateStatus(total, duplicate, empty, valid) {
      document.getElementById('totalCount').textContent = total;
      document.getElementById('duplicateCount').textContent = duplicate;
      document.getElementById('emptyCount').textContent = empty;
      document.getElementById('validCount').textContent = valid;
    }

    function analyzeHistory() {
      log('å¼€å§‹åˆ†æå†å²è®°å½•...', 'info');

      const stored = localStorage.getItem('chat_history');
      if (!stored) {
        log('æ²¡æœ‰æ‰¾åˆ°å†å²è®°å½•', 'warning');
        updateStatus(0, 0, 0, 0);
        return;
      }

      try {
        const data = JSON.parse(stored);
        const total = data.length;

        // åˆ†æé‡å¤çš„ conversationId
        const conversationIds = data.map(h => h.conversationId).filter(Boolean);
        const uniqueIds = new Set(conversationIds);
        const duplicateCount = conversationIds.length - uniqueIds.size;

        // åˆ†æç©ºå¯¹è¯
        const emptyDialogs = data.filter(item => !item.messages || item.messages.length === 0);
        const emptyCount = emptyDialogs.length;

        // æœ‰æ•ˆå¯¹è¯
        const validCount = total - duplicateCount - emptyCount;

        updateStatus(total, duplicateCount, emptyCount, validCount);

        log(`åˆ†æå®Œæˆï¼å…± ${total} æ¡è®°å½•`, 'success');
        if (duplicateCount > 0) {
          log(`å‘ç° ${duplicateCount} æ¡é‡å¤è®°å½•`, 'warning');
        }
        if (emptyCount > 0) {
          log(`å‘ç° ${emptyCount} æ¡ç©ºè®°å½•`, 'warning');
        }

        // æ˜¾ç¤ºè¯¦ç»†åˆ—è¡¨
        showDetails(data, duplicateCount, emptyCount);

      } catch (e) {
        log(`åˆ†æå¤±è´¥: ${e.message}`, 'error');
      }
    }

    function showDetails(data, duplicateCount, emptyCount) {
      const detailList = document.getElementById('detailList');
      detailList.innerHTML = '';
      detailList.style.display = 'block';

      if (duplicateCount === 0 && emptyCount === 0) {
        detailList.innerHTML = '<div class="detail-item"><div class="detail-title">âœ… æ‰€æœ‰è®°å½•éƒ½æ­£å¸¸ï¼</div></div>';
        return;
      }

      // æ‰¾å‡ºé‡å¤çš„è®°å½•
      const conversationIdMap = new Map();
      data.forEach((item, index) => {
        if (item.conversationId) {
          if (!conversationIdMap.has(item.conversationId)) {
            conversationIdMap.set(item.conversationId, []);
          }
          conversationIdMap.get(item.conversationId).push({ ...item, originalIndex: index });
        }
      });

      // æ˜¾ç¤ºé‡å¤è®°å½•
      conversationIdMap.forEach((items, conversationId) => {
        if (items.length > 1) {
          items.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'detail-item duplicate';
            div.innerHTML = `
                            <div class="detail-title">ğŸ”„ é‡å¤è®°å½• ${idx + 1}/${items.length}: ${item.title || 'æœªå‘½å'}</div>
                            <div class="detail-meta">
                                å¯¹è¯ID: ${conversationId}<br>
                                æ¶ˆæ¯æ•°é‡: ${item.messages?.length || 0}<br>
                                æ›´æ–°æ—¶é—´: ${item.updatedAt || item.createdAt || 'æœªçŸ¥'}
                            </div>
                        `;
            detailList.appendChild(div);
          });
        }
      });

      // æ˜¾ç¤ºç©ºè®°å½•
      data.forEach((item, index) => {
        if (!item.messages || item.messages.length === 0) {
          const div = document.createElement('div');
          div.className = 'detail-item empty';
          div.innerHTML = `
                        <div class="detail-title">ğŸ“­ ç©ºè®°å½•: ${item.title || 'æœªå‘½å'}</div>
                        <div class="detail-meta">
                            å¯¹è¯ID: ${item.conversationId || 'N/A'}<br>
                            åˆ›å»ºæ—¶é—´: ${item.createdAt || 'æœªçŸ¥'}
                        </div>
                    `;
          detailList.appendChild(div);
        }
      });
    }

    function cleanHistory() {
      log('å¼€å§‹æ¸…ç†å†å²è®°å½•...', 'info');

      const stored = localStorage.getItem('chat_history');
      if (!stored) {
        log('æ²¡æœ‰æ‰¾åˆ°å†å²è®°å½•', 'warning');
        return;
      }

      try {
        const data = JSON.parse(stored);
        const originalCount = data.length;

        // å»é‡å’Œæ¸…ç†
        const uniqueMap = new Map();
        let removedDuplicates = 0;
        let removedEmpty = 0;

        data.forEach(item => {
          // è·³è¿‡ç©ºå¯¹è¯
          if (!item.messages || item.messages.length === 0) {
            removedEmpty++;
            log(`ç§»é™¤ç©ºå¯¹è¯: ${item.title || 'æœªå‘½å'}`, 'warning');
            return;
          }

          const key = item.conversationId || item.id;
          if (!key) return;

          const existing = uniqueMap.get(key);
          if (!existing) {
            uniqueMap.set(key, item);
          } else {
            // ä¿ç•™æ¶ˆæ¯æ›´å¤šçš„è®°å½•
            const existingMsgCount = existing.messages?.length || 0;
            const currentMsgCount = item.messages?.length || 0;
            const existingTime = new Date(existing.updatedAt || existing.createdAt).getTime();
            const currentTime = new Date(item.updatedAt || item.createdAt).getTime();

            if (currentMsgCount > existingMsgCount ||
              (currentMsgCount === existingMsgCount && currentTime > existingTime)) {
              log(`æ›¿æ¢é‡å¤è®°å½•: ${item.title}`, 'info');
              uniqueMap.set(key, item);
            } else {
              log(`ç§»é™¤é‡å¤è®°å½•: ${item.title}`, 'warning');
            }
            removedDuplicates++;
          }
        });

        const cleanedData = Array.from(uniqueMap.values());
        const finalCount = cleanedData.length;

        // ä¿å­˜æ¸…ç†åçš„æ•°æ®
        localStorage.setItem('chat_history', JSON.stringify(cleanedData));

        log('æ¸…ç†å®Œæˆï¼', 'success');
        log(`åŸå§‹è®°å½•: ${originalCount} æ¡`, 'info');
        log(`ç§»é™¤é‡å¤: ${removedDuplicates} æ¡`, 'warning');
        log(`ç§»é™¤ç©ºå¯¹è¯: ${removedEmpty} æ¡`, 'warning');
        log(`ä¿ç•™è®°å½•: ${finalCount} æ¡`, 'success');
        log('å³å°†åˆ·æ–°é¡µé¢...', 'info');

        // æ›´æ–°çŠ¶æ€
        updateStatus(finalCount, 0, 0, finalCount);

        // 2ç§’ååˆ·æ–°é¡µé¢
        setTimeout(() => {
          window.opener?.location.reload();
          location.reload();
        }, 2000);

      } catch (e) {
        log(`æ¸…ç†å¤±è´¥: ${e.message}`, 'error');
      }
    }

    function clearAll() {
      if (!confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        return;
      }

      log('æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•...', 'warning');
      localStorage.removeItem('chat_history');
      log('å·²æ¸…ç©ºæ‰€æœ‰è®°å½•', 'success');
      updateStatus(0, 0, 0, 0);
      document.getElementById('detailList').style.display = 'none';

      setTimeout(() => {
        window.opener?.location.reload();
        location.reload();
      }, 1000);
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åˆ†æ
    window.onload = () => {
      log('å·¥å…·å·²å°±ç»ª', 'success');
      analyzeHistory();
    };
  </script>
</body>

</html>